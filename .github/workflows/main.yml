name: CI CD Pipeline

on:
  push:
     branches:
        - main

jobs:
   build-and-deploy:
       runs-on: ubuntu-latest

       steps:
        - name: checkout repository
          uses: actions/checkout@v3

        - name: setup docker buildx
          uses: docker/setup-buildx-action@v3

        - name: docker login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.docker_username }}
            password: ${{ secrets.docker_password }}

        - name : docker build and push
          uses: docker/build-push-action@v5
          with:
             push: true
             tags: asomaaroufiniyaa/node_app:latest


        - name: ssh to AWS and run container
          uses: appleboy/ssh-action@v0.1.7
          with:
            host: ${{ secrets.AWS_Host }}
            username: ubuntu
            key: ${{ secrets.AWS_Key }}

            script: |
              sudo apt update
              sudo apt install -y ca-certificates curl gnupg lsb-release
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
              https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
              sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              docker pull asomaaroufiniyaa/node_app:latest
              docker stop my-website || true
              docker rm my-website || true
              docker run -d -p 2020:80 --name my-site asomaaroufiniyaa/node_app:latest
          
            
